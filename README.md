# spyfall
این پروژه یک ربات تلگرام برای اجرای بازی **Spyfall** به زبان فارسی است که با استفاده از **Cloudflare Workers** و پایگاه داده **D1** پیاده‌سازی شده است. این ربات امکان مدیریت بازی، تخصیص نقش‌ها (جاسوس، شهروند، جوکر، کلانتر)، و استفاده از واژگان سفارشی را فراهم می‌کند.

## ویژگی‌ها
- مدیریت بازی با نقش‌های تصادفی و رمز بازی.
- پشتیبانی از واژگان سفارشی در قالب JSON.
- حذف خودکار پیام‌های حساس.
- استفاده از پایگاه داده D1 برای ذخیره‌سازی داده‌ها.
- رابط کاربری با منوهای اینلاین برای گاد.
- نقش کلانتر: در تیم شهروند است اما به جای واژه رمز، راهنمایی را میبیند. باید با شناسایی جاسوس ها به آنها شلیک کند. در صورت شلیک اشتباه، جاسوس ها برنده میشوند.
- نقش جوکر: در تیم جاسوس است. واژه رمز را میبیند اما با جاسوس ها بیدار نمیشود. باید تلاش کند تا با جلب توجه شهروندان به خود باعث برد جاسوس شود.

## پیش‌نیازها
- حساب **Cloudflare**
- توکن ربات تلگرام (دریافت از [BotFather](https://t.me/BotFather)).

## راهنمای نصب (با استفاده از پنل Cloudflare)

### ۱. ایجاد Worker در Cloudflare
1. به داشبورد Cloudflare بروید و وارد حساب خود شوید.
2. از منوی سمت چپ، به بخش **Workers and Pages** بروید.
3. روی **Create Worker** کلیک کنید و یک نام برای Worker خود انتخاب کنید (مثلاً `spyfall-bot`).
4. کد پروژه (فایل `worker.js`) را کپی کرده و در ویرایشگر آنلاین Cloudflare جای‌گذاری کنید.

### ۲. تنظیم پایگاه داده D1
1. در داشبورد Cloudflare، به بخش **Storage & databases** > **D1** بروید.
2. روی **Create Database** کلیک کنید و نامی مانند `spyfall-db` انتخاب کنید.
3. پس از ایجاد پایگاه داده، به بخش **Console** در D1 بروید و کوئری‌های زیر را برای ایجاد جداول وارد کرده و execute را بزنید:

```sql
CREATE TABLE game (
  key TEXT PRIMARY KEY,
  value TEXT
);

CREATE TABLE words (
  id INTEGER PRIMARY KEY,
  word TEXT NOT NULL,
  hint TEXT NOT NULL
);

CREATE TABLE messages_to_delete (
  chat_id TEXT NOT NULL,
  message_id TEXT NOT NULL,
  delete_at INTEGER NOT NULL,
  PRIMARY KEY (chat_id, message_id)
);
```

### ۳. اتصال پایگاه داده به Worker
1. در داشبورد Cloudflare، به Worker خود (`spyfall-bot`) بروید.
2. به تب **Settings** > **Bindings** بروید.
3. در بخش **D1 Database Bindings**، یک binding جدید اضافه کنید:
   - **Binding name**: `D1`
   - **Database**: نام پایگاه داده خود (مثلاً `spyfall-db`).
4. تغییرات را ذخیره کنید.

### ۴. تنظیم متغیرهای محیطی
1. در صفحه Worker، به تب **Settings** > **Environment Variables** بروید.
2. متغیرهای زیر را اضافه کنید:

   - **TELEGRAM_TOKEN**: توکن ربات تلگرام دریافت‌شده از BotFather (مثلا 123456789:ABCDEFghijklmnopqrstuvwxyz1234567890)
   - **MASTER_PASSWORD**: رمز مستر برای دسترسی به منوی گاد (مثلاً `123`).
   - **WORDS_PROMPT**:
     ```
     تولید 20 واژه و راهنمایی برای بازی Spyfall به زبان فارسی در فرمت JSON. واژه‌ها باید ساده، روزمره، و متنوع باشن (شامل مکان، غذا، اشیای ورزشی، اشیای روزمره، مفاهیم ساده) و نه خیلی عام (مثل "خونه") و نه تخصصی (مثل "میکروسکوپ"). هر واژه یه "id" یکتا، "word"، و "hint" داره. راهنمایی‌ها باید:
     - ۲ جمله، غیرمستقیم، دوپهلو، و بدون اشاره به دسته‌بندی (مثل "جایی"، "یه چیز"، "طعم").
     - مرتبط با حس و حال، موقعیت، یا کاربرد واژه باشن، طوری که جاسوس به چند گزینه فکر کنه (مثل "چوب بیلیارد": "با این یه ضربه دقیق می‌زنی. نیاز به مهارت داره").
     - از کلمات کلیدی واضح (مثل "داغ"، "شمالی") یا گمراه‌کننده اجتناب کن.
     مثال:
     [
       {"id": 1, "word": "بالکن", "hint": "هوای تازه می‌خوای، اینجا می‌ری. گاهی چشماتو به دوردست می‌دوئ."},
       {"id": 2, "word": "حلیم", "hint": "صبح‌های سرد دنبالش می‌گردی. هم زدنش صبر می‌خواد."}
     ]
     فرمت خروجی:
     [
       {"id": 1, "word": "...", "hint": "..."},
       ...
     ]
     ```

3. تغییرات را ذخیره کنید.

### ۵. استقرار Worker
1. در ویرایشگر Worker، روی **Deploy** کلیک کنید تا کد روی سرورهای Cloudflare مستقر شود.
2. URL Worker خود را یادداشت کنید (مثلاً `https://spyfall-bot.your-username.workers.dev`).

### ۶. وب هوک
1. در قسمت settings، قسمت Domains & Routes در سطر اول جدول لینک ورکر خود را کپی و جایی ذخیره کنید (مثلا mafia-bot.you.workers.dev).
2. مرورگر خود را باز کنید و درخواست زیر را برای تنظیم Webhook ارسال کنید:

<div dir="ltr">
  
https://api.telegram.org/bot<توکن تلگرام>/setWebhook?url=https://<لینک ورکر شما>
</div>
مثال:
<div dir="ltr">
  
https://api.telegram.org/bot123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11/setWebhook?url=https://mafia-bot.example.workers.dev/
</div>

3. در صورت موفقیت، پاسخی مانند {"ok":true,"result":true,"description":"Webhook was set"} دریافت خواهید کرد.

   ### دستورات ربات
- `/god`: ورود به حالت گاد (نیاز به رمز مستر).
- `/r`: ریست بازی (نیاز به تأیید و رمز مستر).
- **رمز بازی**: برای پیوستن بازیکنان به بازی (توسط گاد تنظیم می‌شود).

### نکته

متغیر **WORDS_PROMPT** یک پرامپت آماده است که با ارسال آن به هوش مصنوعی، میتوانید واژه و راهنمایی جهت بازی دریافت کنید. پیشنهاد میکنم هر دفعه از یک چت ثابت واژه بگیرید تا واژه تکراری دریافت نکنید. اگر موفق به ساخت پرامپت بهتر شدید در گیتهاب برای من ارسال کنید تا دیگران هم از آن استفاده کنند. 
